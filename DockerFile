# Stage 1: Build the Go app
FROM golang:1.23.4 AS builder

# Set working directory
WORKDIR /app

# Copy Go modules first to leverage Docker cache
COPY go.mod go.sum ./

# Download dependencies
RUN go mod tidy

# Copy the rest of the application files
COPY . .

# Build application
RUN go build -o myapp ./coin-api

# Stage 2: Run the application
FROM debian:latest

# Set working directory
WORKDIR /root/

# Copy the built binary from builder
COPY --from=builder /app/myapp .

# Ensure the binary is executable
RUN chmod +x /root/myapp

# Expose the port (match your app's listening port)
EXPOSE 8080

# Run the application
CMD ["/root/myapp"]
